---
title: "Data Prep"
author: "Raphaël Morsomme"
date: "January 16, 2020"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 4,
                      fig.width = 6,
                      echo = FALSE)

library(tidyverse)
library(GGally) # ggpairs()
library(tidyimpute) # NA imputation
library(na.tools) # NA imputation
library(MASS)
library(sure) # Surrogate Residuals
library(rstanarm)
library(EnvStats) # Introduce the Box Cox transform for lipid adjustment
my_standardize <- function(x) (x - mean(x, na.rm = T)) / sd(x, na.rm = T)
```

## Data Preparation

- drop albumin
- remove female with length of gestation superior to 45 weeks and dichotomize the variable
- aggregate scaled PCB's (could do PCA)
- total fat
- exposure (quantity of chemical in environment)

```{r data prep}
d <- readRDS("Longnecker.rds") %>%
  
  mutate_at(vars(center, smoking_status), factor) %>%
  dplyr::select(-albumin) %>% # too many NAs
  
  # Dependent Variable
  filter(gestational_age <= 45) %>% # more accurate treatment would be to allow for error in measurement since the number of weeks is only estimated (there is room for error)
  mutate(outcome_2 = case_when(gestational_age <= 37 ~ "Pre term",
                               TRUE                  ~ "At term"),
         outcome_3 = case_when(gestational_age <= 34 ~ "0Dangerous",
                               gestational_age <= 37 ~ "1Pre term",
                               TRUE                  ~ "2At term")) %>%
  mutate(outcome_3 = outcome_3 %>% factor) %>%
  
  # Aggregate PCBs
  mutate_at(vars(starts_with("pcb")), my_standardize) %>% # standardize pcb's to give them all equal weight in the aggregate pcb variable
  rowwise() %>%
  mutate(pcb = mean(c(pcb_028, pcb_052, pcb_074, pcb_105, pcb_118, pcb_153, pcb_170, pcb_138, pcb_180, pcb_194, pcb_203))) %>%
  ungroup %>%
  
  # Fat
  mutate(fat = 2.27 * cholesterol + triglycerides + 0.623) %>% # https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3893492/
  
  # Exposure
  mutate(dde_env = dde / fat,
         pcb_env = pcb / fat) %>%
  
  # NA
  impute_if(na.mean, is.numeric) %>%
  #impute_if(na.mode, is.character) %>% # not necessary
  
  dplyr::select(starts_with("outcome"), # Y
                starts_with("dde|pcb"), # X
                starts_with("score"), race, maternal_age, center, smoking_status, # Z
                everything())
```
```{r}
# Box Cox transform of fat
d$dde_env_bc = d$dde/log(d$fat)
d$pcb_env_bc = d$pcb/log(d$fat)
d$race_agg = "white"
d[d$race!="white", ]$race_agg = "non white"
```
## EDA

- justify aggregation of pcb: they are all correlated, tell the same story, reduce number of predictor (more stable parameter estimation).
- dde & pcb per outcome_3: (i) white less exposed to dde, (ii) "dangerous" has larger value of dde, (iii) no clear relationship for pcb
- fat per race
- gestation per race & per center


```{r, fig_height = 3}
d %>% 
  dplyr::select(dde, pcb, pcb_028 : pcb_203) %>%
  #mutate_all(~(log(. + 0.1))) %>%
  ggcorr(palette = "RdBu", label = TRUE)
```

```{r}
d %>%
  ggplot(aes(x = outcome_3, y = dde_env, fill = race)) +
  geom_violin()

d %>%
  ggplot(aes(x = outcome_3, y = pcb_env, fill = race)) +
  geom_violin()
```

```{r}
d %>%
  ggplot(aes(x = race, y = fat, fill = race)) +
  geom_violin()
```

```{r}
d %>%
  ggplot(aes(x=race, fill = outcome_3)) +
  geom_bar(position = "fill")

d %>%
  ggplot(aes(x=reorder(center, outcome_3 != "2At term"), fill = outcome_3)) +
  geom_bar(position = "fill")
```
```{r}
# DDE and outcome_3
ggplot(d) +
  geom_density(aes(x=dde_env_bc, color=outcome_3), alpha = 0.5)
# PCB and outcome_3
ggplot(d) +
  geom_density(aes(x=pcb_env_bc, color=outcome_3), alpha = 0.5)
```
```{r}
# PCB and outcome_3
ggplot(d) +
  geom_boxplot(aes(x=outcome_3,y=pcb_env_bc, fill=race_agg))
# DDE and outcome_3
ggplot(d) +
  geom_boxplot(aes(x=outcome_3,y=dde_env_bc, fill=race_agg))
```

## Model
<<<<<<< HEAD
### Model Building
The cumulative logistics model(ordinal regression model) is fitted. The model is paramterized as:
$$
logit(P(Y\leq j))=\beta_{j0}-\eta_1x_1-\cdots-\eta_px_p
$$
=======

The cumulative logistics model is fitted. First, we detect the full model. Then, we make a variable selection.
```{r}
d_subset= d %>% 
  dplyr::select(outcome_3, dde_env,
                pcb_env,race,maternal_age,score_occupation,
                center,score_income,score_education, smoking_status)
cumlogit_model_env_full = polr(outcome_3 ~ . + center*dde_env 
                               + center*pcb_env +
                                 race*dde_env +
                                 race*pcb_env, data=d_subset,
                          method = c("logistic"))
summary(cumlogit_model_env_full)
```
without the correction for fat
```{r}
d_subset= d %>% 
  dplyr::select(outcome_3, dde,
                pcb,race,maternal_age,score_occupation,
                center,score_income,score_education)
cumlogit_model_env_full = polr(outcome_3 ~ . + center*dde 
                               + center*pcb +
                                 race*dde +
                                 race*pcb, data=d_subset,
                          method = c("logistic"))
summary(cumlogit_model_env_full)
```

```{r}
# Variable selection
cumlogit_model_env_selected=stepAIC(cumlogit_model_env_full,direction="both")
summary(cumlogit_model_env_selected)
res=resids(cumlogit_model_env_selected) #surrogate residuals
autoplot(res, what = "covariate", x =d$pcb_env, xlab = "PCB/Lipids")
autoplot(res, what = "covariate", x =d$dde_env, xlab = "DDE/Lipids")
```
```{r}
# Parameter interpretations
exp(coef(cumlogit_model_env_selected))
```
Interpretation: following the reasoning in the UCLA guide, the odds of of being more likely to have a less dangerous delivery are multiplied by
\begin{itemize}
\item $0.0184957$ if $DDE/Lipid$ increases by 1\% unit
\item $0.00$ if $PCB/Lipid$ increases by 1\% unit
\end{itemize}
\textcolor{red}{this intepretation does not make sense. It should be the opposite}.

```{r}
d_subset= d %>% 
  dplyr::select(outcome_3, dde_env_bc,
                pcb_env_bc,race_agg,maternal_age,score_occupation,
                center,score_income,score_education, smoking_status)
cum_logit_model_bc= polr(outcome_3 ~ . + dde_env_bc*race_agg + pcb_env_bc*race_agg + dde_env_bc*center + pcb_env_bc*center, data=d_subset,method = c("logistic"))
cumlogit_model_env_selected=stepAIC(cum_logit_model_bc,direction="both")
summary(cumlogit_model_env_selected)
exp(-coef(cumlogit_model_env_selected))
#summary(cum_logit_model_bc)
#exp(-coef(cum_logit_model_bc))
```

```{r}
res=resids(cum_logit_model_bc) #surrogate residuals
autoplot(res, what = "covariate", x =d$pcb_env_bc, xlab = "PCB/Lipids")
autoplot(res, what = "covariate", x =d$dde_env_bc, xlab = "DDE/Lipids")
autoplot(res, what = "qq", x =d$pcb_env_bc, xlab = "PCB/Lipid")
autoplot(res, what = "qq", x =d$DDE_env_bc, xlab = "DDE/Lipid")
```

>>>>>>> 5c53b49feb7ab6049906407b37f87af9bcd739bd
```{r}
cumlogit_model_env=polr(
  outcome_3 ~ dde_env + pcb_env + race + maternal_age + score_occupation + center + score_income + score_education, 
  d, 
  method = c("logistics"))
summary(cumlogit_model_env)
```

<<<<<<< HEAD
Besides, the cumulative Logit model w/o env is fitted.
=======
Cumulative Logit model w/o env considering lipid is fitted.

```{r}
###Model 1_
library(MASS)
cumlogit_model=polr(outcome_3 ~ dde + pcb + race + maternal_age + score_occupation + center + score_income+score_education,             d, 
     method = c("logistic"))
summary(cumlogit_model)
#exp(-coef(cumlogit_model))
```

<<<<<<< HEAD
### Variable Selection
=======
-Variable Selection (AIC)
Stepwise regression by AIC is used to select variables. The final model we choose is "outcome_3 ~ dde_env + pcb_env + center + score_education".
```{r}
finalmodel=stepAIC(cumlogit_model_env,direction="both")
```

### Model Diagnostics
- Boxcox transformation of lambda for lipid adjustment
```{r}
# A function to implement box-cox
boxcox_transfomation = function(y, lambda){
  if(lambda==0){
    return(log(y))
  } else {
    return((y^lambda-1)/lambda)
  }
}
# Import the original data
d_boxcox_check= d %>% 
  dplyr::select(outcome_3, dde,
                pcb,race,maternal_age,score_occupation,
                center,score_income,score_education, smoking_status)

cumlogit_model_env_full = polr(outcome_3 ~ . + center*dde_env 
                               + center*pcb_env +
                                 race*dde_env +
                                 race*pcb_env, data=d_subset,
                          method = c("logistic"))
summary(cumlogit_model_env_full)
```

-Model Checking (i) residuals 
Surrogate residuals are used to check if the model assumption is correct, as suggested by (Liu and Zhang, 2017). If the model assumptions are correct, then the surrogate residuals $R_S$ will have three properties:
\begin{itemize}
 \item $E(R_S|X)=0$
 \item $Var(R_S|X)=c$, the conditional variance of $R_S$ is constant
 \item The emiprical distribution of $R_S$ resembles an explicit distribution that is related to the link function $G^{-1}(\cdot)$. Specifically, $R_S\sim G(c+\int ud G(u))$.
\end{itemize}

The surrogate residuals vs covariate plot is used to check the first and second properties. The QQ-plot is used to check the third property.

-Residual vs Pcb 
The surrogate residuals are scatter around 0 evenly. This plot indicates that $E(R_S|X)=0$ and $Var(R_S|X)=c$ are basically satisfied.
```{r}
res=resids(finalmodel) #surrogate residuals
autoplot(res, what = "covariate", x =d$pcb, xlab = "pcb")
```

-QQ-plot 
Both the theoretical quantiles and sample quantiles match quite well. Our model assumptions are appropriate.
```{r}
autoplot(res, what = "qq", x =d$dde, xlab = "dde")
```

(ii) (probabilistic) predictive model checking
Will check & compare with other competing models.

### Try to fit a Bayesian model
A Bayesian model is fitted. 5 chains with 3000 iterations each are ran. All Rhats are closed to 1 and effective sample sizes exceed 8000, so there is strong evidence that the chains converge. 
```{r}
d$pcb_env_1<-d$pcb_env*100
m <- stan_polr(
  outcome_3 ~ dde_env + pcb_env_1 +  score_education + center ,
  d,
  iter=3*1e2,
  chains=5,
  method = "logistic", 
  prior = NULL)
m %>% summary
```
-Printing the 95% credible intervals
```{r}
posterior_interval(m,prob=.95) 
```
-Histrograms of posterior draws for each coefficient are plotted
```{r}
plot(m,"hist")
```


## Interpretation

The explanation of coefficients are as follows:
If other covariates are held constant, when a covariate $x$ increases by one unit, the cumulative odd ratio $\frac{Pr(Y\leq j)}{1-Pr(Y\leq j)}$ increases by $(exp(-\eta_x)-1)*100\%$. 

Printing
```{r}
exp(-posterior_interval(m,prob=.95))-1
```
-
## Try to summarize the result





